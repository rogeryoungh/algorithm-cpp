<!DOCTYPE html>
<html><head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta name="generator" content="Hugo 0.110.0-DEV">

  
  
  <link rel="stylesheet" href="/scss/index.min.95ba81376e079da48068412714d3b5b407c6cec0c5edbf6ebc255278b7938d7c.css">

</head>
<body>
  <div id="app"><header class="py-5 text-4 flex justify-center shadow print:hidden color-primary">
  <nav class="mx-20 w-full max-w-240 flex flex-wrap justify-center items-center whitespace-nowrap sm:flex-nowrap sm:justify-between">
    <div class="flex basis-full items-stretch justify-center sm:basis-auto">
      <img class="w-12 h-12 self-center" src="https://rogery.dev/img/logo.png">
      <a class="pl-5 font-bold flex self-center text-5" href="/"> Roger Young </a>
    </div>
    <ul class="pl-0 flex mt-5 self-center sm:mt-0">
      <button class="m-3 self-center" id="theme-switcher">
        <i class="i-carbon-automatic text-4">Sun</i>
      </button>
      
        <li class="flex"><a class="m-3" href="/">Home</a></li>
      
        <li class="flex"><a class="m-3" href="/post/base/">List</a></li>
      
        <li class="flex"><a class="m-3" href="/post">Post</a></li>
      
        <li class="flex"><a class="m-3" href="https://github.com/rogeryoungh/algorithm-cpp">ğŸ¤© GitHub</a></li>
      
    </ul>
  </nav>
</header>


<main class="px-5 flex justify-center">
  <article class="article w-full max-w-210 my-10">
    <header class="my-20">
      <h1 class="text-8 text-center folt-bold"> è·³è¡¨ </h1>
      <a
        class="text-center-my-6 hidden print:block"
        href="https://rogery.dev/">
        rogeryoungh
      </a>
      <div class="text-center">
        
        
        0001 å¹´ 1 æœˆ 1 æ—¥
        
      </div>
    </header>
    
      <h1> ç›®å½• </h1><nav id="TableOfContents">
  <ol>
    <li><a href="#ç†è®º">ç†è®º</a></li>
    <li><a href="#ä»£ç ">ä»£ç </a></li>
  </ol>
</nav>
    <section class="content-frame my-10">
      <h2 id="ç†è®º">ç†è®º</h2>
<p>key-value é”®å€¼å¯¹å¿«é€Ÿå¢åˆ æŸ¥æ”¹,å¤æ‚åº¦åŒçº¢é»‘æ ‘ï¼Œå®ç°è¾ƒä¸ºç®€å•ã€‚</p>
<h2 id="ä»£ç ">ä»£ç </h2>



<pre><code class="language-cpp">#ifndef ALGO_DATASTRUCT_SKIPLIST
#define ALGO_DATASTRUCT_SKIPLIST

#include &quot;../base.hpp&quot;

#include &lt;array&gt;
#include &lt;optional&gt;
#include &lt;queue&gt;
#include &lt;random&gt;

template &lt;typename K, typename V&gt;
struct SkipList {
  enum : u64 {
    MAXL = 32,                                 // æœ€å¤§å±‚æ•°
    P = 4,                                     // æ¦‚ç‡ï¼ˆ1 / 4)
    S = 0xFFFF,                                // é™åˆ¶éšæœºå€¼
    PS = S / P,                                // æ¦‚ç‡
    INVALID = std::numeric_limits&lt;u64&gt;::max(), // æœ€å¤§å€¼ï¼ˆå“¨å…µï¼‰
  };
  /*
      è·³è¡¨ç»“ç‚¹ï¼ˆå±‚æ•°ï¼Œå€¼ï¼ŒæŒ‡é’ˆï¼‰
  */
  struct SkipListNode {
    K key;
    V value;
    i32 level{};
    SkipListNode **forward;
    SkipListNode() = default;
    SkipListNode(K k, V v, i32 l, SkipListNode *nxt = nullptr) {
      key = k;
      value = v;
      level = l;
      forward = new SkipListNode *[l + 1];
      for (i32 i = 0; i &lt;= l; ++i)
        forward[i] = nxt;
    }
    ~SkipListNode() {
      delete[] forward;
    }
  };
  using Node = SkipListNode;
  Node *head, *tail; // ä¸¤æ’å“¨å…µ
  i32 length;        // é“¾è¡¨é•¿åº¦ L0 å±‚
  i32 level;         // å±‚æ•°
  std::mt19937 rng;
  SkipList() : rng(std::random_device{}()) {
    level = length = 0;
    tail = new Node(INVALID, 0, 0);
    head = new Node(INVALID, 0, MAXL, tail);
  }
  ~SkipList() {
    delete head;
    delete tail;
  }
  
  /*
      ç¬¬ä¸€å±‚ 50 % ï¼Œ ç¬¬äºŒå±‚ 25 % ï¼Œç¬¬ä¸‰å±‚ 12.5% ä¾æ­¤ç±»æ¨ï¼Œ P = 1 / 4
  */
  i32 randomLevel() {
    i32 lv = 1;
    while ((rng() &amp; S) &lt; PS)
      ++lv;
    return MAXL &gt; lv ? lv : MAXL;
  }
  /*
      æ’å…¥æ–°ç»“ç‚¹ï¼Œ
  */
  V &amp;insert(const K &amp;key, const V &amp;value) {
    std::array&lt;Node *, MAXL + 1&gt; update{};
    Node *p = head;
    for (i32 i = level; i &gt;= 0; --i) {
      while (p-&gt;forward[i]-&gt;key &lt; key) {
        p = p-&gt;forward[i];
      }
      update[i] = p;
    }
    p = p-&gt;forward[0];
    if (p-&gt;key == key) {
      return p-&gt;value = value;
    }
    i32 lv = randomLevel();
    if (lv &gt; level) { // ä¸€æ¬¡åªä¼šæ¯”å½“å‰å±‚æ•°é«˜ä¸€å±‚
      lv = ++level;
      update[lv] = head;
    }
    Node *newNode = new Node(key, value, lv);
    for (i32 i = lv; i &gt;= 0; --i) {
      p = update[i];
      newNode-&gt;forward[i] = p-&gt;forward[i];
      p-&gt;forward[i] = newNode;
    }
    ++length;
    return newNode-&gt;value;
  }
  bool erase(const K &amp;key) {
    std::array&lt;Node *, MAXL + 1&gt; update;
    Node *p = head;
    for (i32 i = level; i &gt;= 0; --i) {
      while (p-&gt;forward[i]-&gt;key &lt; key) {
        p = p-&gt;forward[i];
      }
      update[i] = p;
    }
    p = p-&gt;forward[0];
    if (p-&gt;key != key)
      return false;
    for (i32 i = 0; i &lt;= level; ++i) {
      if (update[i]-&gt;forward[i] != p) {
        break;
      }
      update[i]-&gt;forward[i] = p-&gt;forward[i];
    }
    delete p;
    while (level &gt; 0 &amp;&amp; head-&gt;forward[level] == tail)
      --level;
    --length;
    return true;
  }
  std::optional&lt;V&gt; find(const K &amp;key) {
    Node *p = head;
    for (i32 i = level; i &gt;= 0; --i) {
      while (p-&gt;forward[i]-&gt;key &lt; key) {
        p = p-&gt;forward[i];
      }
    }
    p = p-&gt;forward[0];
    if (p-&gt;key == key)
      return p-&gt;value;
    return std::nullopt;
  }
  V &amp;operator[](const K &amp;key) {
    Node *p = head;
    for (i32 i = level; i &gt;= 0; --i) {
      while (p-&gt;forward[i]-&gt;key &lt; key) {
        p = p-&gt;forward[i];
      }
    }
    p = p-&gt;forward[0];
    if (p-&gt;key == key) {
      return p-&gt;value;
    } else {
      return insert(key, 0);
    }
  }
  bool count(const K &amp;key) {
    return find(key) != tail-&gt;value;
  }
};

#endif

</code></pre>



    </section>
    <hr />
    <section class="comment-frame my-10">
      



    </section>
  </article>
</main>


<footer class="my-10 color-secondary text-3 flex items-end justify-center a-underline">
  <span>
    Â© 2023 <a href="https://rogery.dev">Roger Young</a>
  </span>
  <i class="i-carbon-lighting inline-block px-1"></i>
  <span>Powered by <a href="https://gohugo.io/">Hugo</a> &
    <a href="https://github.com/rogeryoungh/hugo-pure">pure</a>
  </span>
</footer>
</div>
  <div>
    
  <link
  crossorigin="anonymous"
  integrity="sha512-mQwom8Ns4op+H29oDkD/LXO/OsXPvCFfkgZkFAVrhhePzRLU8NUI3Nkm43NhWUSmj3p5Cca2HTEkMQmXQRwDQQ=="
  href="https://lib.baomitu.com/KaTeX/0.16.4/katex.min.css" rel="stylesheet">
<script
  crossorigin="anonymous"
  integrity="sha512-sHSNLECRJSK+BFs7E8DiFc6pf6n90bLI85Emiw1jhreduZhK3VXgq9l4kAt9eTIHYAcuQBKHL01QKs4/3Xgl8g=="
  src="https://lib.baomitu.com/KaTeX/0.16.4/katex.min.js"></script>
<script
  crossorigin="anonymous"
  integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg=="
  src="https://lib.baomitu.com/KaTeX/0.16.4/contrib/auto-render.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  renderMathInElement(document.body, {
    delimiters: [
      { left: '$$', right: '$$', display: true },
      { left: '$', right: '$', display: false },
      { left: '\\(', right: '\\)', display: false },
      { left: '\\[', right: '\\]', display: true },
    ],
    globalGroup: true,
    throwOnError: false
  });
});
</script>




  <script
  crossorigin="anonymous"
  src="https://lib.baomitu.com/prism/1.29.0/prism.min.js"></script>
<script
  crossorigin="anonymous"
  src="https://lib.baomitu.com/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>



<script>
let themeSwitch = document.getElementById("theme-switcher");
var icon = themeSwitch.children[0];
let currentPref = localStorage.getItem('pref-theme') || 'auto';
let html = document.documentElement;
let windowPref = window.matchMedia('(prefers-color-scheme: dark)');
function isCurrentDark() {
  let isDark = false;
  if (currentPref === 'light') {
    isDark = false;
  } else if (currentPref === 'dark') {
    isDark = true;
  } else {
    isDark = windowPref.matches;
  }
  return isDark;
}
let reloadTheme = () => {
  icon.classList.remove('i-carbon-moon');
  icon.classList.remove('i-carbon-sun');
  icon.classList.remove('i-carbon-automatic');
  if (currentPref === 'light') {
    icon.classList.add('i-carbon-sun');
  } else if (currentPref === 'dark') {
    icon.classList.add('i-carbon-moon');
  } else {
    icon.classList.add('i-carbon-automatic');
  }
  if (isCurrentDark()) {
    html.classList.add('dark');
  } else {
    html.classList.remove('dark');
  }
  
};
themeSwitch.addEventListener("click", () => {
  icon.classList.remove('i-carbon-moon');
  icon.classList.remove('i-carbon-sun');
  icon.classList.remove('i-carbon-automatic');
  if (currentPref === 'auto') {
    currentPref = 'dark';
    icon.classList.add('i-carbon-moon');
  } else if (currentPref === 'dark') {
    currentPref = 'light';
    icon.classList.add('i-carbon-sun');
  } else {
    currentPref = 'auto';
    icon.classList.add('i-carbon-automatic');
  }
  localStorage.setItem("pref-theme", currentPref);
  reloadTheme();
});
reloadTheme();
</script>


  </div>
</body>

</html>
